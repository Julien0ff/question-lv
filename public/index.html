<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>LunaVerse - Connexion</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <h1 class="brand">LunaVerse School RP — Test Professeur</h1>
    <section class="card">
      <h2>Connexion</h2>
      <form id="loginForm" class="form">
        <label>Identifiant
          <input type="text" name="username" required>
        </label>
        <label>Mot de passe
          <input type="password" name="password" required>
        </label>
        <button type="submit" class="btn primary">Se connecter</button>
      </form>
      <div id="loginMsg" class="msg"></div>
    </section>
  </main>
  <script>
    async function api(path, opts={}) {
      const origin = window.location.origin || 'http://localhost:3000';
      const apiBase = (typeof window !== 'undefined' && window.API_BASE)
        ? window.API_BASE
        : (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) || origin;
      const url = (/^https?:\/\//i).test(path) ? path : apiBase + path;
      
      try {
        console.log('Requête API vers:', url);
        const res = await fetch(url, { 
          ...opts, 
          headers: { 'Content-Type': 'application/json', ...opts.headers }, 
          credentials: 'include', 
          cache: 'no-store' 
        });
        
        if (!res.ok) {
          console.error('Erreur API:', res.status, res.statusText);
          const errorData = await res.json().catch(() => ({}));
          return { error: errorData.error || `Erreur ${res.status}: ${res.statusText}` };
        }
        
        return await res.json();
      } catch (error) {
        console.error('Erreur lors de la requête API:', error);
        return { error: error.message || 'Erreur de connexion au serveur' };
      }
    }
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('loginMsg');
      msg.textContent = 'Tentative de connexion...';
      msg.classList.remove('error');
      
      try {
        const fd = new FormData(e.target);
        const payload = { username: fd.get('username'), password: fd.get('password') };
        console.log('Envoi des données:', payload);
        
        const out = await api('/api/login', { method: 'POST', body: JSON.stringify(payload) });
        console.log('Réponse reçue:', out);
        
        if (out && out.user) {
          msg.textContent = 'Connexion réussie, redirection...';
          if (out.user.role === 'admin') window.location.href = '/admin.html';
          else window.location.href = '/teacher.html';
        } else {
          console.error('Erreur de connexion:', out);
          msg.textContent = (out && out.error) ? out.error : 'Erreur de connexion';
          msg.classList.add('error');
        }
      } catch (error) {
        console.error('Erreur lors de la connexion:', error);
        msg.textContent = 'Erreur technique: ' + error.message;
        msg.classList.add('error');
      }
    });
  </script>
</body>
</html>