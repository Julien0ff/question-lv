<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-size: 18px;">V√©rification de l'authentification...</div>
  <header class="topbar">
    <div class="brand-sm">LunaVerse</div>
    <button id="logoutBtn" class="btn danger">D√©connexion</button>
  </header>
  <main class="container">
    <section class="card">
      <h2>Utilisateurs</h2>
      <form id="createForm" class="form inline">
        <input type="text" name="username" placeholder="Identifiant" required>
        <input type="password" name="password" placeholder="Mot de passe" required>
        <select name="subject" required id="createSubject">
          <option value="">S√©lectionner une mati√®re</option>
          <option value="math">Math√©matiques</option>
          <option value="french">Fran√ßais</option>
          <option value="history">Histoire-G√©o-EMC</option>
          <option value="physics">Physique-Chimie</option>
          <option value="english">Anglais LV1</option>
        </select>
        <select name="role" id="createRole">
          <option value="teacher">Professeur (test)</option>
          <option value="admin">Admin</option>
          <option value="aed">AED (Surveillant)</option>
        </select>
        <button class="btn primary" type="submit">Cr√©er</button>
      </form>
      <div id="usersList" class="list"></div>
    </section>
    <section class="card">
      <h2>R√©sultats</h2>
      <div class="row" style="margin-bottom:12px;gap:12px;align-items:center;">
        <label for="statusFilter">Filtrer par statut</label>
        <select id="statusFilter" class="btn" style="text-transform:none;">
          <option value="all">Tous</option>
          <option value="passed">R√©ussi</option>
          <option value="failed">Refus√©</option>
          <option value="refused_exit_tab">Refus√© onglet</option>
          <option value="none">Pas fait</option>
        </select>
      </div>
      <div id="userCards" class="grid"></div>
    </section>
    <section class="card">
      <h2>Formulaires</h2>
      <form id="formCreate" class="form">
        <div class="row" style="gap:8px; align-items: center; flex-wrap: wrap;">
          <select name="subject" required>
            <option value="">Mati√®re</option>
            <option value="math">Math√©matiques</option>
            <option value="french">Fran√ßais</option>
            <option value="history">Histoire-G√©o-EMC</option>
            <option value="physics">Physique-Chimie</option>
            <option value="english">Anglais LV1</option>
          </select>
          <input type="text" name="title" placeholder="Titre" required>
          <input type="text" name="description" placeholder="Description (optionnel)">
        </div>
        <div class="row" style="gap:8px;align-items:center;margin:6px 0;">
          <button id="createQuestionsUI" class="btn" type="button">√âditer questions (UI)</button>
          <span id="createQuestionsCount" style="font-size:0.9em;color:#666;"></span>
        </div>
        <textarea name="questions" rows="6" style="display:none;" placeholder='Questions (JSON). Exemple:\n[
  {"id":"q1","type":"mcq","prompt":"...","options":["A","B","C"],"correctIndex":1},
  {"id":"q2","type":"text","prompt":"...","answer":"texte"}
]'
          required></textarea>
        <button class="btn primary" type="submit">Ajouter le formulaire</button>
      </form>
      <div id="formsList" class="list" style="margin-top:12px;"></div>
    </section>
  </main>
  <div id="answersModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-icon">üìÑ</div>
      <h3>R√©ponses de l'utilisateur</h3>
      <div id="answersContent" class="answers"></div>
      <button id="answersClose" class="btn">Fermer</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // V√©rification d'authentification (robuste avec repli)
    (async function checkAuth() {
      const loadingEl = document.getElementById('loading');
      try {
        // Essayer d'abord /api/check-auth
        let out = await api('/api/check-auth', { method: 'GET' });
        // Si l‚Äôendpoint n‚Äôexiste pas (404) ou retourne une erreur, tenter /api/me
        if (out && out.error) {
          out = await api('/api/me', { method: 'GET' });
        }

        // Extraire l'objet utilisateur quelle que soit la forme ({ user: {...} } ou {...})
        const user = out && (out.user || out);
        if (!user || !user.role) {
          // Non authentifi√©
          window.location.href = '/';
          return;
        }

        if (user.role !== 'admin') {
          alert('Acc√®s non autoris√©');
          window.location.href = '/';
          return;
        }

        // OK
        loadingEl.style.display = 'none';
      } catch (err) {
        console.error('Erreur de v√©rification auth:', err);
        window.location.href = '/';
      }
    })();
    
    async function api(path, opts={}) {
      const origin = window.location.origin || 'http://localhost:3000';
      const apiBase = (typeof window !== 'undefined' && window.API_BASE)
        ? window.API_BASE
        : (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) || origin;
      const url = (/^https?:\/\//i).test(path) ? path : apiBase + path;
      const res = await fetch(url, { 
        ...opts, 
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // s'assure que le cookie de session est envoy√©
        cache: 'no-store'
      });
      let data;
      try {
        data = await res.json();
      } catch (e) {
        // R√©ponse non-JSON
        data = { error: 'R√©ponse invalide du serveur' };
      }
      if (!res.ok) {
        return { error: data && data.error ? data.error : `Erreur HTTP ${res.status}` };
      }
      return data;
    }
    function statusLabel(s) {
      if (!s) return 'pas fait';
      if (s === 'refused_exit_tab') return 'refus√© (quitt√© onglet)';
      if (s === 'failed') return 'refus√©';
      if (s === 'passed') return 'r√©ussi';
      return s;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>\"']/g, (m) => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '\"':'&quot;', "'":'&#39;'
      })[m]);
    }

    // Normalisation tol√©rante de texte (accents/casse/ponctuation/espaces)
    function normalizeText(text) {
      if (typeof text !== 'string') return '';
      return text
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    let usersCache = [];
    async function loadUsers() {
      const out = await api('/api/admin/users');
      usersCache = out.users || [];
      const el = document.getElementById('usersList');
      el.innerHTML = '';
      (usersCache || []).forEach(u => {
        const row = document.createElement('div');
        row.className = 'row';
        const statusHtml = u.role === 'admin' ? '' : `<span class="badge status ${u.status||'none'}">${statusLabel(u.status)||'‚Äî'}</span>`;
        row.innerHTML = `<div><strong>${u.username}</strong> <span class="badge">${u.role}</span> ${statusHtml}</div>`;
        const del = document.createElement('button');
        del.className = 'btn danger';
        del.textContent = 'Supprimer';
        del.onclick = async () => {
          const ok = await showConfirm(`Supprimer l‚Äôutilisateur ¬´ ${u.username} ¬ª ?`);
          if (!ok) return;
          const out = await api('/api/admin/users/'+u.id, { method: 'DELETE' });
          if (out && out.error) { alert(out.error); return; }
          await loadUsers();
          await loadResults();
        };
        const actions = document.createElement('div'); actions.className = 'row-actions'; actions.appendChild(del);
        row.appendChild(actions);
        el.appendChild(row);
      });
    }

    async function loadResults() {
      const out = await api('/api/admin/results');
      const results = out.results || [];
      const container = document.getElementById('userCards');
      container.innerHTML = '';
      const currentFilter = (document.getElementById('statusFilter') && document.getElementById('statusFilter').value) || 'all';
      usersCache.filter(u => u.role !== 'admin').forEach(u => {
        const rec = results.find(r => r.userId === u.id) || null;
        // Applique le filtre de statut
        if (currentFilter !== 'all') {
          const st = (rec && rec.status) || (u.status || 'none');
          if (st !== currentFilter) return;
        }

        const card = document.createElement('div');
        card.className = 'card user-card';
        const outOf = 20;
        const scorePoints = rec ? (rec.scorePoints || 0) : 0;
        const scoreOn20 = rec ? (typeof rec.scoreOn20 === 'number' ? rec.scoreOn20 : Math.round((scorePoints / (rec.scoreOutOf || outOf || 1)) * 20)) : null;
        const scoreText = rec ? `${scoreOn20}/20` : '‚Äî';
         card.innerHTML = `
           <div class="row" style="justify-content:space-between;align-items:center;">
             <div>
               <div><strong>${u.username}</strong> <span class="badge status ${(rec && rec.status) || u.status || 'none'}">${statusLabel((rec && rec.status) || u.status)}</span></div>
               <div style="font-size:0.9em;color:#666;margin-top:2px;">Note: ${scoreText}</div>
             </div>
             <div class="actions">
               <button class="btn" data-view="${u.id}">Voir r√©ponses</button>
             </div>
           </div>
           <div class="chart-holder"><canvas id="chart-${u.id}" width="120" height="120"></canvas></div>
         `;
        container.appendChild(card);

        // Supprimer utilisateur
        const delBtn = card.querySelector(`[data-del="${u.id}"]`);
        if (delBtn) {
          delBtn.onclick = async () => { await api('/api/admin/users/'+u.id, { method: 'DELETE' }); await loadUsers(); await loadResults(); };
        }

        // Calculs donut s√©curis√©s
        const canvas = card.querySelector(`#chart-${u.id}`);
        const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
        const scoreOutOf = rec && typeof rec.scoreOutOf === 'number' && rec.scoreOutOf > 0 ? rec.scoreOutOf : 1;
        const rawPoints = rec && typeof rec.scorePoints === 'number' ? rec.scorePoints : Math.round(((rec && rec.score) || 0) * scoreOutOf);
        const safePoints = Math.max(0, Math.min(rawPoints || 0, scoreOutOf));
        const remaining = Math.max(0, scoreOutOf - safePoints);
        if (ctx) {
          new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [safePoints, remaining], backgroundColor: ['#4caf50', '#eee'] }] },
            options: { cutout: '70%', plugins: { legend: { display: false } } }
          });
        }
        const btn = card.querySelector(`[data-view="${u.id}"]`);
        btn.onclick = async () => {
          const content = document.getElementById('answersContent');
          const modal = document.getElementById('answersModal');
          try {
            if (!rec) { 
              content.innerHTML = '<em>Aucun r√©sultat</em>'; 
              modal.classList.remove('hidden'); 
              return; 
            }
            
            const answers = rec.answers || [];
            if (!answers.length) {
              content.innerHTML = '<em>Aucune r√©ponse</em>';
              modal.classList.remove('hidden');
              return;
            }
            
            const qres = await api('/api/admin/questions');
            let qmap = {};
            let warned = false;
            if (qres && Array.isArray(qres)) {
              qmap = Object.fromEntries(qres.map(q => [q.id, q]));
            } else if (qres && Array.isArray(qres.questions)) {
              qmap = Object.fromEntries(qres.questions.map(q => [q.id, q]));
            } else {
              // Tentative de fallback direct sur le fichier si la route admin √©choue
              try {
                const origin = window.location.origin || 'http://localhost:3000';
                const raw = await fetch(origin + '/data/questions.json', { credentials: 'include', cache: 'no-store' });
                if (raw.ok) {
                  const arr = await raw.json();
                  if (Array.isArray(arr)) {
                    qmap = Object.fromEntries(arr.map(q => [q.id, q]));
                  } else {
                    warned = true;
                  }
                } else {
                  warned = true;
                }
              } catch (e) {
                warned = true;
              }
              if (warned) {
                const errMsg = qres && qres.error ? qres.error : 'Impossible de charger les questions';
                content.innerHTML = `<div class="msg" style="margin-bottom:8px;">${escapeHtml(errMsg)} ‚Äî affichage des r√©ponses sans libell√©s.</div>`;
              }
            }
            
            let html = '';
            for (let i = 0; i < answers.length; i++) {
              const a = answers[i];
              const q = qmap[a.id];
              let userVal = '';
              let correct = false;
              let correctAnswer = '';
              
              if (a.type === 'mcq') {
                const optText = q && Array.isArray(q.options) ? q.options[a.selectedIndex] : undefined;
                userVal = optText != null ? optText : `option #${a.selectedIndex}`;
                const normalizedCorrectIdx = q && typeof q.correctIndex === 'number'
                  ? (q.correctIndex >= 1 ? q.correctIndex - 1 : q.correctIndex)
                  : -1;
                correct = q && typeof normalizedCorrectIdx === 'number' && a.selectedIndex === normalizedCorrectIdx;
                if (q && Array.isArray(q.options) && typeof normalizedCorrectIdx === 'number' && normalizedCorrectIdx >= 0) {
                  correctAnswer = q.options[normalizedCorrectIdx];
                }
              } else {
                userVal = a.value || '';
                correct = q && typeof q.answer === 'string' && normalizeText(userVal) === normalizeText(q.answer);
                if (q && typeof q.answer === 'string') {
                  correctAnswer = q.answer;
                }
              }
              
              html += `
                <div class="answer-item ${correct ? 'ok' : 'ko'}">
                  <div class="answer-question"><span class="q-index">Q${i+1}</span> ${q ? escapeHtml(q.prompt) : escapeHtml(a.id)}</div>
                  <div class="answer-value">
                    <span class="badge ${correct ? 'passed' : 'failed'}">${correct ? 'Correct' : 'Incorrect'}</span> 
                    ${escapeHtml(userVal)}
                  </div>
                  ${!correct && correctAnswer ? `<div class="correct-answer" style="margin-top:4px;font-size:0.9em;color:#4caf50;">‚úì R√©ponse correcte : ${escapeHtml(correctAnswer)}</div>` : ''}
                </div>`;
            }
            content.innerHTML = html;
            modal.classList.remove('hidden');
          } catch (error) {
            console.error('Erreur lors de l\'ouverture de la modale:', error);
            const errText = (error && (error.message || String(error))) || 'Erreur inconnue';
            content.innerHTML = `<div class="answers"><em>Erreur lors de l'affichage des r√©ponses</em><div class="msg" style="margin-top:8px;">${escapeHtml(errText)}</div></div>`;
            modal.classList.remove('hidden');
          }
        };
        // Sauvegarde de la note admin directement depuis la carte (d√©sactiv√© pour l'instant)
      });
    }

    document.getElementById('answersClose').onclick = () => {
      document.getElementById('answersModal').classList.add('hidden');
    };
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const role = fd.get('role');
      const subject = role === 'teacher' ? fd.get('subject') : '';
      const payload = { username: fd.get('username'), password: fd.get('password'), role, subject };
      const submitBtn = e.target.querySelector('[type="submit"]');
      const prevText = submitBtn && submitBtn.textContent;
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Cr√©ation...'; }
      const out = await api('/api/admin/users', { method: 'POST', body: JSON.stringify(payload) });
      if (!out || out.error) {
        alert(out && out.error ? out.error : 'Erreur lors de la cr√©ation');
      } else {
        e.target.reset();
      }
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = prevText; }
      await loadUsers();
    });

    // Basculer la mati√®re selon le r√¥le (teacher seulement)
    (function bindRoleSubjectToggle(){
      const roleSel = document.getElementById('createRole');
      const subjSel = document.getElementById('createSubject');
      if (!roleSel || !subjSel) return;
      const apply = () => {
        const isTeacher = roleSel.value === 'teacher';
        subjSel.required = isTeacher;
        subjSel.disabled = !isTeacher;
        subjSel.style.opacity = isTeacher ? '1' : '0.6';
      };
      roleSel.addEventListener('change', apply);
      apply();
    })();

    document.getElementById('statusFilter').addEventListener('change', loadResults);

    async function init() {
      await ensureDefaults();
      await loadUsers();
      await loadResults();
      await loadForms();
    }

    async function ensureDefaults() {
      // glow des labels statuts
      const style = document.createElement('style');
      style.textContent = `
        .status.passed { background: #4caf50; color: white; }
        .status.failed { background: #f44336; color: white; }
        .status.refused_exit_tab { background: #ff9800; color: white; }
        .status.none { background: #999; color: white; }
        .answer-item { border: 1px solid #eee; border-radius: 8px; padding: 8px; margin-bottom: 8px; }
        .answer-item.ok { background: #e6ffe6; border-color: #c8e6c9; }
        .answer-item.ko { background: #ffe6e6; border-color: #ffcdd2; }
        .answer-question { font-weight: bold; margin-bottom: 4px; color: #000 !important; }
        .answer-value { display: flex; gap: 8px; align-items: center; color: #000 !important; }
      `;
      document.head.appendChild(style);
    }

    // D√©connexion
    document.getElementById('logoutBtn').onclick = async () => {
      await api('/api/logout', { method: 'POST' });
      window.location.href = '/';
    };

    init();

    // ----------- Gestion des formulaires -----------
    async function loadForms() {
      const out = await api('/api/forms');
      const forms = Array.isArray(out) ? out : (out.forms || []);
      const el = document.getElementById('formsList');
      el.innerHTML = '';
      if (!forms.length) {
        el.innerHTML = '<em>Aucun formulaire</em>';
        return;
      }
      forms.forEach(f => {
        const row = document.createElement('div');
        row.className = 'row';
        const qCount = Array.isArray(f.questions) ? f.questions.length : 0;
        row.innerHTML = `
          <div>
            <strong>${escapeHtml(f.title)}</strong> <span class="badge">${escapeHtml(f.subject)}</span>
            <div style="font-size:0.9em;color:#666;">${qCount} question(s)</div>
          </div>
          <div class="row-actions">
            <button class="btn" data-edit="${f.id}">√âditer</button>
            <button class="btn danger" data-del="${f.id}">Supprimer</button>
          </div>`;
        el.appendChild(row);

        const delBtn = row.querySelector(`[data-del="${f.id}"]`);
        delBtn.onclick = async () => {
          const ok = await showConfirm('Supprimer ce formulaire ?');
          if (!ok) return;
          const r = await api('/api/forms/' + f.id, { method: 'DELETE' });
          if (r && r.error) alert(r.error);
          await loadForms();
        };

        const editBtn = row.querySelector(`[data-edit="${f.id}"]`);
        editBtn.onclick = () => openFormEditModal(f);
      });
    }

    document.getElementById('formCreate').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const subject = fd.get('subject');
      const title = fd.get('title');
      const description = fd.get('description') || '';
      let questionsText = fd.get('questions');
      let questions;
      try {
        questions = JSON.parse(questionsText);
      } catch (e) {
        alert('Questions JSON invalide');
        return;
      }
      const btn = e.target.querySelector('[type="submit"]');
      const prev = btn.textContent; btn.disabled = true; btn.textContent = 'Ajout...';
      const out = await api('/api/forms', { method: 'POST', body: JSON.stringify({ subject, title, description, questions }) });
      btn.disabled = false; btn.textContent = prev;
      if (!out || out.error) {
        alert(out && out.error ? out.error : 'Erreur lors de la cr√©ation');
        return;
      }
      e.target.reset();
      await loadForms();
    });

    // Bouton UI pour cr√©ation de questions
    (function bindCreateQuestionsUI(){
      const btn = document.getElementById('createQuestionsUI');
      const ta = document.querySelector('textarea[name="questions"]');
      const cnt = document.getElementById('createQuestionsCount');
      if (!btn || !ta) return;
      const setCount = () => { const arr = safeJsonParse(ta.value||'[]', []); const n = Array.isArray(arr)?arr.length:0; if (cnt) cnt.textContent = `${n} question(s)`; };
      setCount();
      btn.onclick = async () => {
        const initial = safeJsonParse(ta.value||'[]', []);
        const updated = await openQuestionsBuilder(initial);
        if (updated) {
          ta.value = JSON.stringify(updated, null, 2);
          setCount();
        }
      };
    })();

    // Modale de confirmation (promesse)
    async function showConfirm(message='√ätes-vous s√ªr ?') {
      let modal = document.getElementById('confirmModal');
      if (!modal) {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <div id="confirmModal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-icon">‚ö†Ô∏è</div>
              <h3 id="confirmMessage">Confirmer</h3>
              <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="confirmCancel" class="btn">Annuler</button>
                <button id="confirmOk" class="btn danger">Confirmer</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(wrap.firstElementChild);
        modal = document.getElementById('confirmModal');
      }
      modal.querySelector('#confirmMessage').textContent = message;
      modal.classList.remove('hidden');
      return new Promise((resolve) => {
        const onCancel = () => { cleanup(); resolve(false); };
        const onOk = () => { cleanup(); resolve(true); };
        const cleanup = () => {
          modal.classList.add('hidden');
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
        };
        const okBtn = modal.querySelector('#confirmOk');
        const cancelBtn = modal.querySelector('#confirmCancel');
        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
      });
    }

    function openFormEditModal(form) {
      let modal = document.getElementById('formEditModal');
      if (!modal) {
        const tpl = document.createElement('div');
        tpl.innerHTML = `
          <div id="formEditModal" class="modal">
            <div class="modal-content">
              <div class="modal-icon">‚úèÔ∏è</div>
              <h3>√âditer le formulaire</h3>
              <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;">
                <select id="editSubject" required>
                  <option value="math">Math√©matiques</option>
                  <option value="french">Fran√ßais</option>
                  <option value="history">Histoire-G√©o-EMC</option>
                  <option value="physics">Physique-Chimie</option>
                  <option value="english">Anglais LV1</option>
                </select>
                <input type="text" id="editTitle" placeholder="Titre" required>
                <input type="text" id="editDescription" placeholder="Description (optionnel)">
              </div>
              <div class="row" style="gap:8px;margin:6px 0;">
                <button id="editQuestionsUI" class="btn" type="button">√âditer questions (UI)</button>
                <span id="editQuestionsCount" style="font-size:0.9em;color:#666;"></span>
              </div>
              <textarea id="editQuestions" rows="8" placeholder="Questions (JSON)" required></textarea>
              <div class="row" style="justify-content: flex-end; gap: 8px;">
                <button id="editCancel" class="btn">Annuler</button>
                <button id="editSave" class="btn primary">Enregistrer</button>
              </div>
            </div>
          </div>`;
        // IMPORTANT: use firstElementChild to avoid selecting a text node
        document.body.appendChild(tpl.firstElementChild);
        modal = document.getElementById('formEditModal');
        const cancelBtn = modal.querySelector('#editCancel');
        if (cancelBtn) cancelBtn.onclick = () => modal.classList.add('hidden');
      }
      // Query within modal to avoid null due to DOM collisions
      modal.querySelector('#editSubject').value = form.subject || '';
      modal.querySelector('#editTitle').value = form.title || '';
      modal.querySelector('#editDescription').value = form.description || '';
      modal.querySelector('#editQuestions').value = JSON.stringify(form.questions || [], null, 2);
      const qCnt = Array.isArray(form.questions) ? form.questions.length : 0;
      const cntEl = modal.querySelector('#editQuestionsCount');
      if (cntEl) cntEl.textContent = `${qCnt} question(s)`;
      const editUIBtn = modal.querySelector('#editQuestionsUI');
      if (editUIBtn) {
        editUIBtn.onclick = async () => {
          const current = safeJsonParse(modal.querySelector('#editQuestions').value || '[]', []);
          const updated = await openQuestionsBuilder(current);
          if (updated) {
            modal.querySelector('#editQuestions').value = JSON.stringify(updated, null, 2);
            const qn = Array.isArray(updated) ? updated.length : 0;
            if (cntEl) cntEl.textContent = `${qn} question(s)`;
          }
        };
      }
      modal.classList.remove('hidden');
      const saveBtn = modal.querySelector('#editSave');
      saveBtn.onclick = async () => {
        const subject = modal.querySelector('#editSubject').value || '';
        const title = modal.querySelector('#editTitle').value || '';
        const description = modal.querySelector('#editDescription').value || '';
        let questionsRaw = modal.querySelector('#editQuestions').value || '[]';
        let questions;
        try { questions = JSON.parse(questionsRaw); } catch (e) { alert('Questions JSON invalide'); return; }
        saveBtn.disabled = true; const prev = saveBtn.textContent; saveBtn.textContent = 'Enregistrement...';
        const out = await api('/api/forms/' + form.id, { method: 'PUT', body: JSON.stringify({ subject, title, description, questions }) });
        saveBtn.disabled = false; saveBtn.textContent = prev;
        if (!out || out.error) { alert(out && out.error ? out.error : 'Erreur lors de la mise √† jour'); return; }
        modal.classList.add('hidden');
        await loadForms();
      };
    }

    function safeJsonParse(str, fallback){
      try { return JSON.parse(str); } catch { return fallback; }
    }

    async function openQuestionsBuilder(initialQuestions){
      let modal = document.getElementById('questionsBuilderModal');
      if (!modal) {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <div id="questionsBuilderModal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-icon">üß±</div>
              <h3>√âditeur de questions</h3>
              <div id="qbList" class="list" style="margin-bottom:8px;"></div>
              <div class="row" style="gap:8px;">
                <button id="qbAddMCQ" class="btn" type="button">Ajouter QCM</button>
                <button id="qbAddText" class="btn" type="button">Ajouter texte</button>
              </div>
              <div class="row" style="justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="qbCancel" class="btn" type="button">Annuler</button>
                <button id="qbSave" class="btn primary" type="button">Enregistrer</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(wrap.firstElementChild);
        modal = document.getElementById('questionsBuilderModal');
      }

      let questions = Array.isArray(initialQuestions) ? JSON.parse(JSON.stringify(initialQuestions)) : [];
      const listEl = modal.querySelector('#qbList');
      const render = () => {
        listEl.innerHTML = '';
        questions.forEach((q, idx) => {
          const row = document.createElement('div');
          row.className = 'row';
          row.style.alignItems = 'flex-start';
          const header = document.createElement('div');
          header.innerHTML = `<strong>Q${idx+1}</strong> <span class="badge">${escapeHtml(q.type||'text')}</span>`;
          const handle = document.createElement('button');
          handle.className = 'btn drag-handle';
          handle.textContent = '‚â°';
          handle.setAttribute('draggable','true');
          handle.ondragstart = (e) => { e.dataTransfer.setData('text/plain', String(idx)); };
          const controls = document.createElement('div');
          controls.className = 'row-actions';
          const delBtn = document.createElement('button'); delBtn.className = 'btn danger icon-btn'; delBtn.textContent = 'üóëÔ∏è'; delBtn.title = 'Supprimer'; delBtn.onclick = () => { questions.splice(idx,1); render(); };
          controls.appendChild(delBtn);
          row.appendChild(handle);
          row.appendChild(header);
          row.appendChild(controls);

          const detail = document.createElement('div');
          detail.style.flex = '1';
          detail.style.marginTop = '6px';
          detail.innerHTML = `
            <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center;">
              <select data-k="type">
                <option value="mcq" ${q.type==='mcq'?'selected':''}>QCM</option>
                <option value="text" ${q.type!=='mcq'?'selected':''}>Texte</option>
              </select>
              <input type="text" data-k="prompt" placeholder="√ânonc√©" value="${escapeHtml(q.prompt||'')}">
            </div>
            <div data-part="mcq" style="${q.type==='mcq'?'':'display:none;'};margin-top:6px;">
              <div id="opt-${idx}" class="list" style="margin-bottom:6px;"></div>
              <button class="btn" data-act="addOpt">Ajouter option</button>
              <div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
                <span>Index correct (0-based) :</span>
                <input type="number" min="0" style="width:80px;" data-k="correctIndex" value="${typeof q.correctIndex==='number'?q.correctIndex:''}">
                <small data-k-hint="correctIndex" style="opacity:0.85;color:#ffcc80;"></small>
              </div>
            </div>
            <div data-part="text" style="${q.type==='mcq'?'display:none;':''};margin-top:6px;">
              <input type="text" data-k="answer" placeholder="R√©ponse attendue" value="${escapeHtml(q.answer||'')}">
            </div>
          `;
          // drag & drop: droppable sur les lignes, draggable via handle uniquement
          row.draggable = true;
          row.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', String(idx));
            row.classList.add('dragging');
          };
          row.ondragend = () => {
            row.classList.remove('dragging');
            row.classList.remove('drag-over');
          };
          row.ondragover = (e) => { e.preventDefault(); row.classList.add('drag-over'); };
          row.ondragenter = () => { row.classList.add('drag-over'); };
          row.ondragleave = () => { row.classList.remove('drag-over'); };
          row.ondrop = (e) => {
            e.preventDefault();
            row.classList.remove('drag-over');
            const from = Number(e.dataTransfer.getData('text/plain'));
            const to = idx;
            if (!Number.isNaN(from) && from !== to) {
              const [item] = questions.splice(from,1);
              questions.splice(to,0,item);
              render();
            }
          };

          row.appendChild(detail);
          listEl.appendChild(row);

          // Bindings
          const typeSel = detail.querySelector('select[data-k="type"]');
          const promptInp = detail.querySelector('input[data-k="prompt"]');
          const mcqPart = detail.querySelector('[data-part="mcq"]');
          const textPart = detail.querySelector('[data-part="text"]');
          typeSel.onchange = () => { q.type = typeSel.value; if (q.type==='mcq'){ textPart.style.display='none'; mcqPart.style.display='block'; } else { mcqPart.style.display='none'; textPart.style.display='block'; } };
          promptInp.oninput = () => { q.prompt = promptInp.value; };

          // Options list
          q.options = Array.isArray(q.options) ? q.options : [];
          // Champs d'index correct et hint, d√©clar√©s avant renderOpts pour √©viter les erreurs d'initialisation
          const corrInp = detail.querySelector('input[data-k="correctIndex"]');
          const corrHint = detail.querySelector('[data-k-hint="correctIndex"]');
          const updateCorrHint = () => {
            const v = Number(corrInp && corrInp.value);
            const len = Array.isArray(q.options) ? q.options.length : 0;
            if (!Number.isNaN(v)) q.correctIndex = v;
            if (len > 0 && v >= len) {
              corrHint.textContent = `Max ${len-1}`;
            } else {
              corrHint.textContent = '';
            }
          };
          if (corrInp) corrInp.oninput = updateCorrHint;

          const optHolder = detail.querySelector(`#opt-${idx}`);
          const renderOpts = () => {
            optHolder.innerHTML='';
            q.options.forEach((opt,optIdx) => {
              const optRow = document.createElement('div'); optRow.className='row';
              optRow.innerHTML = `
                <input type="text" value="${escapeHtml(opt)}" data-oi="${optIdx}" style="flex:1;">
                <button class="btn danger" data-rem="${optIdx}">X</button>
              `;
              optHolder.appendChild(optRow);
              const inp = optRow.querySelector('input');
              const rem = optRow.querySelector('button');
              inp.oninput = () => { q.options[optIdx] = inp.value; };
              rem.onclick = () => { q.options.splice(optIdx,1); renderOpts(); updateCorrHint(); };
            });
            updateCorrHint();
          };
          renderOpts();
          const addOptBtn = detail.querySelector('button[data-act="addOpt"]');
          addOptBtn.onclick = () => { q.options.push(''); renderOpts(); };
          const ansInp = detail.querySelector('input[data-k="answer"]');
          ansInp.oninput = () => { q.answer = ansInp.value; };
        });
      };

      const addMCQ = modal.querySelector('#qbAddMCQ');
      const addText = modal.querySelector('#qbAddText');
      // Emp√™che toute interf√©rence avec les √©v√©nements de drag & drop
      ['mousedown','mouseup','click','dragstart'].forEach(evt => {
        addMCQ.addEventListener(evt, (e) => e.stopPropagation(), { passive: true });
        addText.addEventListener(evt, (e) => e.stopPropagation(), { passive: true });
      });
      addMCQ.onclick = () => { questions.push({ id: `q${questions.length+1}`, type:'mcq', prompt:'', options:[], correctIndex:0 }); render(); };
      addText.onclick = () => { questions.push({ id: `q${questions.length+1}`, type:'text', prompt:'', answer:'' }); render(); };
      const cancelBtn = modal.querySelector('#qbCancel');
      const saveBtn = modal.querySelector('#qbSave');
      modal.classList.remove('hidden');
      render();
      return new Promise((resolve) => {
        const cleanup = () => { modal.classList.add('hidden'); cancelBtn.onclick = null; saveBtn.onclick = null; };
        cancelBtn.onclick = () => { cleanup(); resolve(null); };
        saveBtn.onclick = () => { cleanup(); resolve(questions); };
      });
    }
  </script>
</body>
</html>
