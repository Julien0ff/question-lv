<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Professeur - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="brand-sm">LunaVerse</div>
    <button id="logoutBtn" class="btn danger">Déconnexion</button>
  </header>
  <main class="container">
    <section class="card">
      <h2>Votre progression</h2>
      <p>Formulaire d'aptitude professionnelle :</p>
      <div id="progress"></div>
      <div class="actions">
        <button id="startBtn" class="btn primary">Commencer le test</button>
      </div>
      <div id="info" class="msg"></div>
    </section>
    <section class="card">
      <h2>Formulaires Restants</h2>
      <div id="remainingForms"></div>
    </section>
    <section class="card">
      <h2>Formulaires complétés</h2>
      <div id="completedForms"></div>
    </section>
  </main>
  <script>
    let currentUser = null; // Variable pour stocker les informations de l'utilisateur

    async function api(path, opts={}) {
      const origin = window.location.origin || 'http://localhost:3000';
      const apiBase = (typeof window !== 'undefined' && window.API_BASE)
        ? window.API_BASE
        : (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) || origin;
      const url = (/^https?:\/\//i).test(path) ? path : apiBase + path;
      const res = await fetch(url, { ...opts, headers: { 'Content-Type': 'application/json' }, credentials: 'include', cache: 'no-store' });
      let data;
      try {
        data = await res.json();
      } catch (e) {
        console.error('Erreur lors du parsing JSON:', e);
        // Réponse non-JSON
        data = { error: 'Réponse invalide du serveur' };
      }
      if (!res.ok) {
        return { error: data && data.error ? data.error : `Erreur HTTP ${res.status}` };
      }
      return data;
    }

    async function fetchUserData() {
      console.log('Fetching user data...');
      const response = await api('/api/me');
      console.log('Raw user data from /api/me:', response.user);
      if (response.user) {
        currentUser = response.user;
        console.log('Current user:', currentUser);
        if (currentUser.role === 'teacher' && currentUser.subject) {
          fetchAndDisplayForms(currentUser.subject);
          fetchAndDisplayCompletedForms(); // Call this after currentUser is set
        }
      } else {
        console.log('User not authenticated, redirecting to login.');
        window.location.href = '/'; // Redirect to login if not authenticated
      }
    }

    async function fetchAndDisplayForms(subject) {
      console.log('Fetching and displaying forms for subject:', subject);
      const formsContainer = document.getElementById('remainingForms');
      formsContainer.innerHTML = '<p>Chargement des formulaires...</p>';
      try {
        const allForms = await api(`/api/forms/subject/${subject}`);
        console.log('API response for allForms:', allForms);
        if (allForms.error) {
          formsContainer.innerHTML = `<p>Erreur lors du chargement des formulaires: ${allForms.error}</p>`;
          return;
        }
        const validAllForms = Array.isArray(allForms) ? allForms : [];
        console.log('Valid allForms:', validAllForms);

        const completedFormsResults = await api('/api/teacher/forms/results'); // Get all completed forms for the teacher
        console.log('API response for completedFormsResults:', completedFormsResults);
        if (completedFormsResults.error) {
          formsContainer.innerHTML = `<p>Erreur lors du chargement des résultats des formulaires: ${completedFormsResults.error}</p>`;
          return;
        }
        const validCompletedFormsResults = Array.isArray(completedFormsResults) ? completedFormsResults : [];
        console.log('Valid completedFormsResults:', validCompletedFormsResults);

        const userCompletedFormIds = validCompletedFormsResults
          .filter(result => result.userId === currentUser.id)
          .map(result => result.formId);
        console.log('User completed form IDs:', userCompletedFormIds);

        const remainingForms = validAllForms.filter(form => !userCompletedFormIds.includes(form.id));
        console.log('Remaining forms:', remainingForms);

        if (remainingForms.length > 0) {
          formsContainer.innerHTML = ''; // Clear loading message
          remainingForms.forEach(form => {
            const formCard = document.createElement('div');
            formCard.className = 'card form-card'; // Add a class for styling
            formCard.innerHTML = `
              <h3>${form.title}</h3>
              <p>${form.description}</p>
              <button class="btn primary" onclick="startForm('${form.id}')">Commencer</button>
            `;
            formsContainer.appendChild(formCard);
          });
        } else {
          formsContainer.innerHTML = '<p>Aucun formulaire disponible pour cette matière.</p>';
        }
      } catch (error) {
        console.error('Erreur lors du chargement des formulaires:', error);
        formsContainer.innerHTML = '<p>Erreur lors du chargement des formulaires.</p>';
      }
    }

    async function startForm(formId) {
      console.log(`startForm called with formId: ${formId}`);
      // Correction pour les IDs de formulaire
      const formIdToUse = formId;
      const out = await api(`/api/form/questions/${formIdToUse}`);
      console.log('API response for /api/form/questions:', out);
      if (out.error) {
        console.error('API Error:', out.error);
        document.getElementById('info').textContent = out.error;
      } else {
        console.log('Setting testQuestions in sessionStorage:', out.questions);
        sessionStorage.setItem('testQuestions', JSON.stringify(out.questions));
        console.log('Redirecting to /test.html');
        window.location.href = '/test.html';
      }
    }

    async function fetchAndDisplayCompletedForms() {
      console.log('Fetching and displaying completed forms...');
      const completedFormsContainer = document.getElementById('completedForms');
      completedFormsContainer.innerHTML = '<p>Chargement des formulaires complétés...</p>';
      try {
        const allCompletedForms = await api('/api/teacher/forms/results');
        if (allCompletedForms.error) {
          completedFormsContainer.innerHTML = `<p>Erreur lors du chargement des formulaires complétés: ${allCompletedForms.error}</p>`;
          return;
        }
        const validAllCompletedForms = Array.isArray(allCompletedForms) ? allCompletedForms : [];
        console.log('Valid allCompletedForms:', validAllCompletedForms);
        const userCompletedForms = validAllCompletedForms.filter(result => result.userId === currentUser.id);
        console.log('User completed forms:', userCompletedForms);

        if (userCompletedForms.length > 0) {
          completedFormsContainer.innerHTML = '';
          userCompletedForms.forEach(result => {
            const resultCard = document.createElement('div');
            resultCard.className = 'card result-card';
            resultCard.innerHTML = `
              <h3>${result.title}</h3>
              <p>Matière: ${result.subject}</p>
              <p>Score: ${result.scorePoints}/${result.totalQuestions}</p>
              <p>Date: ${new Date(result.date).toLocaleString()}</p>
            `;
            completedFormsContainer.appendChild(resultCard);
          });
        } else {
          completedFormsContainer.innerHTML = '<p>Aucun formulaire complété pour le moment.</p>';
        }
      } catch (error) {
        console.error('Erreur lors du chargement des formulaires complétés:', error);
        completedFormsContainer.innerHTML = '<p>Erreur lors du chargement des formulaires complétés.</p>';
      }
    }

    async function refreshProgress() {
  const out = await api('/api/user/progress');
  console.log('Progress data (out):', out);
  const el = document.getElementById('progress');
  const startBtn = document.getElementById('startBtn');
  const infoEl = document.getElementById('info');

  const outOf = 20;
  const scorePoints = (typeof out.scorePoints === 'number') ? out.scorePoints : Math.round((out.score||0) * (out.scoreOutOf||outOf));
  const note20 = (typeof out.scoreOn20 === 'number') ? out.scoreOn20 : Math.round((scorePoints / (out.scoreOutOf || outOf || 1)) * 20);

  if (out.lastStatus && (out.lastStatus === 'in_progress' || out.lastStatus === 'pending')) {
    el.textContent = `Statut: ${out.lastStatus} | Note: ${note20}/20`;
    startBtn.disabled = true;
    infoEl.textContent = out.lastStatus === 'refused_exit_tab' ? "Refusé automatiquement (quitter l'onglet)." : 'Le test a déjà été effectué.';
  } else if (out.lastStatus) {
    el.textContent = `Statut: ${out.lastStatus} | Note: ${note20}/20`;
    startBtn.disabled = true; // Test completed, so disable button
    infoEl.textContent = 'Le test a déjà été effectué.';
  } else {
    el.textContent = `Questions restantes: ${out.remaining}/${out.total}`;
    startBtn.disabled = false;
    infoEl.textContent = '';
  }
  
  // Afficher les formulaires matière dans la section progression
  try {
    const subjectResults = await api('/api/teacher/forms/subject-results');
    if (subjectResults && Array.isArray(subjectResults) && subjectResults.length > 0) {
      const progressInfo = document.createElement('div');
      progressInfo.className = 'progress-info';
      progressInfo.innerHTML = '<h3>Progression des formulaires matière</h3>';
      
      subjectResults.forEach(result => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <p>${result.title}: ${result.scorePoints}/${result.totalQuestions}</p>
          <p>Date: ${new Date(result.date).toLocaleDateString()}</p>
        `;
        progressInfo.appendChild(resultItem);
      });
      
      el.parentNode.appendChild(progressInfo);
    }
  } catch (error) {
    console.error('Erreur lors du chargement des formulaires matière:', error);
  }
}
    document.getElementById('startBtn').addEventListener('click', async () => {
      const out = await api('/api/questions');
      if (out.error) {
        console.error('API Error:', out.error);
        document.getElementById('info').textContent = out.error;
      } else {
        sessionStorage.setItem('testQuestions', JSON.stringify(out.questions));
        window.location.href = '/test.html';
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await api('/api/logout', { method: 'POST' });
      window.location.href = '/';
    });
    fetchUserData(); // Call this to fetch user data and then forms
    // fetchAndDisplayCompletedForms(); // Moved inside fetchUserData
    refreshProgress();
  </script>
</body>
</html>