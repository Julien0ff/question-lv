<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Professeur - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="brand-sm">LunaVerse</div>
    <button id="logoutBtn" class="btn danger">D√©connexion</button>
  </header>
  <main class="container">
    <section class="card">
      <h2>Votre progression</h2>
      <p>Formulaire d'aptitude professionnelle :</p>
      <div id="progress"></div>
      <div class="actions">
        <button id="startBtn" class="btn primary">Commencer le test</button>
      </div>
      <div id="info" class="msg"></div>
    </section>
    <section class="card">
      <h2>Formulaires Restants</h2>
      <div id="remainingForms"></div>
    </section>
    <section class="card">
      <h2>Formulaires compl√©t√©s</h2>
      <div id="completedForms"></div>
    </section>
  </main>
  <script>
    let currentUser = null; // Variable pour stocker les informations de l'utilisateur

    // S'assure que la modale de r√©ponses existe dans le DOM
    function ensureAnswersModal() {
      if (!document.getElementById('answersModal')) {
        const modalTpl = document.createElement('div');
        modalTpl.innerHTML = `
          <div id="answersModal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-icon">üìÑ</div>
              <h3>R√©ponses du formulaire</h3>
              <div id="answersContent" class="answers"></div>
              <button id="answersClose" class="btn">Fermer</button>
            </div>
          </div>`;
        document.body.appendChild(modalTpl.firstChild);
        document.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'answersClose') {
            const m = document.getElementById('answersModal');
            if (m) m.classList.add('hidden');
          }
        });
      }
    }

    async function api(path, opts={}) {
      const origin = window.location.origin || 'http://localhost:3000';
      const apiBase = (typeof window !== 'undefined' && window.API_BASE)
        ? window.API_BASE
        : (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) || origin;
      const url = (/^https?:\/\//i).test(path) ? path : apiBase + path;
      const res = await fetch(url, { ...opts, headers: { 'Content-Type': 'application/json' }, credentials: 'include', cache: 'no-store' });
      let data;
      try {
        data = await res.json();
      } catch (e) {
        console.error('Erreur lors du parsing JSON:', e);
        // R√©ponse non-JSON
        data = { error: 'R√©ponse invalide du serveur' };
      }
      if (!res.ok) {
        return { error: data && data.error ? data.error : `Erreur HTTP ${res.status}` };
      }
      return data;
    }

    async function fetchUserData() {
      console.log('Fetching user data...');
      const response = await api('/api/me');
      console.log('Raw user data from /api/me:', response.user);
      if (response.user) {
        currentUser = response.user;
        console.log('Current user:', currentUser);
        // Afficher les formulaires compl√©t√©s (incluant le test de base) pour tous les r√¥les
        fetchAndDisplayCompletedForms();

        // Les formulaires par mati√®re ne concernent que les enseignants avec une mati√®re d√©finie
        if (currentUser.role === 'teacher' && currentUser.subject) {
          fetchAndDisplayForms(currentUser.subject);
        } else {
          // Cacher la section "Formulaires Restants" si non applicable
          const remainingSection = document.getElementById('remainingForms');
          if (remainingSection) remainingSection.parentElement.style.display = 'none';
        }
      } else {
        console.log('User not authenticated, redirecting to login.');
        window.location.href = '/'; // Redirect to login if not authenticated
      }
    }

    async function fetchAndDisplayForms(subject) {
      console.log('Fetching and displaying forms for subject:', subject);
      const formsContainer = document.getElementById('remainingForms');
      formsContainer.innerHTML = '<p>Chargement des formulaires...</p>';
      try {
        const allForms = await api(`/api/forms/subject/${subject}`);
        console.log('API response for allForms:', allForms);
        if (allForms.error) {
          formsContainer.innerHTML = `<p>Erreur lors du chargement des formulaires: ${allForms.error}</p>`;
          return;
        }
        const validAllForms = Array.isArray(allForms) ? allForms : [];
        console.log('Valid allForms:', validAllForms);

        const completedFormsResults = await api('/api/teacher/forms/subject-results'); // R√©sultats des formulaires mati√®re du professeur
        console.log('API response for completedFormsResults:', completedFormsResults);
        if (completedFormsResults.error) {
          formsContainer.innerHTML = `<p>Erreur lors du chargement des r√©sultats des formulaires: ${completedFormsResults.error}</p>`;
          return;
        }
        const validCompletedFormsResults = Array.isArray(completedFormsResults) ? completedFormsResults : [];
        console.log('Valid completedFormsResults:', validCompletedFormsResults);

        const userCompletedFormIds = validCompletedFormsResults
          .filter(result => result.userId === currentUser.id)
          .map(result => result.formId);
        console.log('User completed form IDs:', userCompletedFormIds);

        const remainingForms = validAllForms.filter(form => !userCompletedFormIds.includes(form.id));
        console.log('Remaining forms:', remainingForms);

        if (remainingForms.length > 0) {
          formsContainer.innerHTML = ''; // Clear loading message
          remainingForms.forEach(form => {
            const formCard = document.createElement('div');
            formCard.className = 'card form-card'; // Add a class for styling
            formCard.innerHTML = `
              <h3>${form.title}</h3>
              <p>${form.description}</p>
              <button class="btn primary" onclick="startForm('${form.id}')">Commencer</button>
            `;
            formsContainer.appendChild(formCard);
          });
        } else {
          formsContainer.innerHTML = '<p>Aucun formulaire disponible pour cette mati√®re.</p>';
        }
      } catch (error) {
        console.error('Erreur lors du chargement des formulaires:', error);
        formsContainer.innerHTML = '<p>Erreur lors du chargement des formulaires.</p>';
      }
    }

    async function startForm(formId) {
      console.log(`startForm called with formId: ${formId}`);
      // Correction pour les IDs de formulaire
      const formIdToUse = formId;
      const out = await api(`/api/form/questions/${formIdToUse}`);
      console.log('API response for /api/form/questions:', out);
      if (out.error) {
        console.error('API Error:', out.error);
        document.getElementById('info').textContent = out.error;
      } else {
        console.log('Setting testQuestions in sessionStorage:', out.questions);
        sessionStorage.setItem('testQuestions', JSON.stringify(out.questions));
        sessionStorage.setItem('currentFormId', formId);
        console.log('Redirecting to /test.html');
        window.location.href = '/test.html';
      }
    }

    async function fetchAndDisplayCompletedForms() {
      console.log('Fetching and displaying completed forms...');
      const completedFormsContainer = document.getElementById('completedForms');
      completedFormsContainer.innerHTML = '';

      // Toujours afficher le test de base si disponible
      try {
        const baseProgress = await api('/api/user/progress');
        if (baseProgress && baseProgress.lastStatus) {
          const card = document.createElement('div');
          card.className = 'card result-card';
          const safeOutOf = (typeof baseProgress.scoreOutOf === 'number' && baseProgress.scoreOutOf > 0) ? baseProgress.scoreOutOf : 1;
          const safePoints = Math.max(0, Math.min(baseProgress.scorePoints || 0, safeOutOf));
          const remaining = Math.max(0, safeOutOf - safePoints);
          const baseId = `base-${(baseProgress.date || '').replace(/[^0-9]/g,'')}`;
          card.innerHTML = `
            <h3>${baseProgress.title || 'Formulaire d\'aptitude professionnelle'}</h3>
            <p>Mati√®re: ${baseProgress.subject || 'G√©n√©ral'}</p>
            <p>Score: ${safePoints}/${safeOutOf}</p>
            <p>Date: ${baseProgress.date ? new Date(baseProgress.date).toLocaleString() : '‚Äî'}</p>
            <button class="btn" data-view="${baseId}">Voir r√©ponses</button>
            <div class="chart-holder"><canvas id="chart-${baseId}" width="90" height="90"></canvas></div>
          `;
          completedFormsContainer.appendChild(card);
          const canvas = card.querySelector(`#chart-${baseId}`);
          const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
          if (ctx && window.Chart) {
            new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [safePoints, remaining], backgroundColor: ['#4caf50', '#eee'] }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
          }
          const btn = card.querySelector(`[data-view="${baseId}"]`);
          btn.onclick = async () => {
            ensureAnswersModal();
            const modal = document.getElementById('answersModal');
            const content = document.getElementById('answersContent');
            try {
              const answers = baseProgress.answers || [];
              const origin = window.location.origin || 'http://localhost:3000';
              const raw = await fetch(origin + '/data/questions.json', { credentials: 'include', cache: 'no-store' });
              let qmap = {};
              if (raw.ok) {
                const arr = await jsonSafe(raw);
                if (Array.isArray(arr)) qmap = Object.fromEntries(arr.map(q => [q.id, q]));
              }
              let html = '';
              for (let i = 0; i < answers.length; i++) {
                const a = answers[i];
                const q = qmap[a.id];
                let userVal = '';
                let correct = false;
                let correctAnswer = '';
                if (a.type === 'mcq') {
                  const normalizedCorrectIdx = q && typeof q.correctIndex === 'number' ? (q.correctIndex >= 1 ? q.correctIndex - 1 : q.correctIndex) : -1;
                  userVal = q && Array.isArray(q.options) ? (q.options[a.selectedIndex] || `option #${a.selectedIndex}`) : `option #${a.selectedIndex}`;
                  correct = q && typeof normalizedCorrectIdx === 'number' && a.selectedIndex === normalizedCorrectIdx;
                  if (q && Array.isArray(q.options) && normalizedCorrectIdx >= 0) correctAnswer = q.options[normalizedCorrectIdx];
                } else {
                  userVal = a.value || '';
                  correct = q && typeof q.answer === 'string' && normalizeText(userVal) === normalizeText(q.answer);
                  if (q && typeof q.answer === 'string') correctAnswer = q.answer;
                }
                html += `
                  <div class="answer-item ${correct ? 'ok' : 'ko'}">
                    <div class="answer-question"><span class="q-index">Q${i+1}</span> ${q ? escapeHtml(q.prompt) : escapeHtml(a.id)}</div>
                    <div class="answer-value"><span class="badge ${correct ? 'passed' : 'failed'}">${correct ? 'Correct' : 'Incorrect'}</span> ${escapeHtml(userVal)}</div>
                    ${!correct && correctAnswer ? `<div class="correct-answer" style="margin-top:4px;font-size:0.9em;color:#4caf50;">‚úì R√©ponse correcte : ${escapeHtml(correctAnswer)}</div>` : ''}
                  </div>`;
              }
              content.innerHTML = html;
              modal.classList.remove('hidden');
            } catch (error) {
              content.innerHTML = `<div class="answers"><em>Erreur lors de l'affichage des r√©ponses</em></div>`;
              modal.classList.remove('hidden');
            }
          };
        }
      } catch (e) {
        // Ne pas bloquer l'affichage si la progression de base √©choue
      }

      // Les formulaires compl√©t√©s par mati√®re (enseignants uniquement)
      if (currentUser && currentUser.role === 'teacher') {
        try {
          const allCompletedForms = await api('/api/teacher/forms/subject-results');
          if (!Array.isArray(allCompletedForms)) return; // ignorer si r√©ponse invalide
          const userCompletedForms = allCompletedForms.filter(result => result.userId === currentUser.id);
          if (userCompletedForms.length === 0) return;

          userCompletedForms.forEach(result => {
            const resultCard = document.createElement('div');
            resultCard.className = 'card result-card';
            resultCard.innerHTML = `
              <h3>${result.title}</h3>
              <p>Mati√®re: ${result.subject}</p>
              <p>Score: ${result.scorePoints}/${result.totalQuestions}</p>
              <p>Date: ${new Date(result.date).toLocaleString()}</p>
              <button class="btn" data-view="${result.id}">Voir r√©ponses</button>
              <div class="chart-holder"><canvas id="chart-${result.id}" width="90" height="90"></canvas></div>
            `;
            completedFormsContainer.appendChild(resultCard);

            const canvas = resultCard.querySelector(`#chart-${result.id}`);
            const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
            const safeOutOf = (typeof result.totalQuestions === 'number' && result.totalQuestions > 0) ? result.totalQuestions : 1;
            const safePoints = Math.max(0, Math.min(result.scorePoints || 0, safeOutOf));
            const remaining = Math.max(0, safeOutOf - safePoints);
            if (ctx && window.Chart) {
              new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [safePoints, remaining], backgroundColor: ['#4caf50', '#eee'] }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
            }

            // Voir r√©ponses mati√®re
            const btn = resultCard.querySelector(`[data-view="${result.id}"]`);
            btn.onclick = async () => {
              const origin = window.location.origin || 'http://localhost:3000';
              ensureAnswersModal();
              const modal = document.getElementById('answersModal');
              const content = document.getElementById('answersContent');
              try {
                const answers = result.answers || [];
                if (!answers.length) { content.innerHTML = '<em>Aucune r√©ponse</em>'; modal.classList.remove('hidden'); return; }
                const raw = await fetch(origin + '/data/forms.json', { credentials: 'include', cache: 'no-store' });
                let qmap = {};
                if (raw.ok) {
                  const arr = await raw.json();
                  const form = Array.isArray(arr) ? arr.find(f => f.id === result.formId) : null;
                  if (form && Array.isArray(form.questions)) qmap = Object.fromEntries(form.questions.map(q => [q.id, q]));
                }
                let html = '';
                for (let i = 0; i < answers.length; i++) {
                  const a = answers[i];
                  const q = qmap[a.id];
                  let userVal = '';
                  let correct = false;
                  let correctAnswer = '';
                  if (a.type === 'mcq') {
                    const normalizedCorrectIdx = q && typeof q.correctIndex === 'number' ? (q.correctIndex >= 1 ? q.correctIndex - 1 : q.correctIndex) : -1;
                    userVal = q && Array.isArray(q.options) ? (q.options[a.selectedIndex] || `option #${a.selectedIndex}`) : `option #${a.selectedIndex}`;
                    correct = q && typeof normalizedCorrectIdx === 'number' && a.selectedIndex === normalizedCorrectIdx;
                    if (q && Array.isArray(q.options) && normalizedCorrectIdx >= 0) correctAnswer = q.options[normalizedCorrectIdx];
                  } else {
                    userVal = a.value || '';
                    correct = q && typeof q.answer === 'string' && normalizeText(userVal) === normalizeText(q.answer);
                    if (q && typeof q.answer === 'string') correctAnswer = q.answer;
                  }
                  html += `
                    <div class="answer-item ${correct ? 'ok' : 'ko'}">
                      <div class="answer-question"><span class="q-index">Q${i+1}</span> ${q ? escapeHtml(q.prompt) : escapeHtml(a.id)}</div>
                      <div class="answer-value">
                        <span class="badge ${correct ? 'passed' : 'failed'}">${correct ? 'Correct' : 'Incorrect'}</span>
                        ${escapeHtml(userVal)}
                      </div>
                      ${!correct && correctAnswer ? `<div class="correct-answer" style="margin-top:4px;font-size:0.9em;color:#4caf50;">‚úì R√©ponse correcte : ${escapeHtml(correctAnswer)}</div>` : ''}
                    </div>`;
                }
                content.innerHTML = html;
                modal.classList.remove('hidden');
              } catch (error) {
                content.innerHTML = `<div class="answers"><em>Erreur lors de l'affichage des r√©ponses</em></div>`;
                modal.classList.remove('hidden');
              }
            };
          });
        } catch (error) {
          // Ignorer les erreurs li√©es aux routes enseignant
        }
      }
    }

    async function refreshProgress() {
  const out = await api('/api/user/progress');
  console.log('Progress data (out):', out);
  const el = document.getElementById('progress');
  const startBtn = document.getElementById('startBtn');
  const infoEl = document.getElementById('info');

  const outOf = 20;
  const scorePoints = (typeof out.scorePoints === 'number') ? out.scorePoints : Math.round((out.score||0) * (out.scoreOutOf||outOf));
  const note20 = (typeof out.scoreOn20 === 'number') ? out.scoreOn20 : Math.round((scorePoints / (out.scoreOutOf || outOf || 1)) * 20);

  if (out.lastStatus && (out.lastStatus === 'in_progress' || out.lastStatus === 'pending')) {
    el.textContent = `Statut: ${out.lastStatus} | Note: ${note20}/20`;
    startBtn.disabled = true;
    infoEl.textContent = out.lastStatus === 'refused_exit_tab' ? "Refus√© automatiquement (quitter l'onglet)." : 'Le test a d√©j√† √©t√© effectu√©.';
  } else if (out.lastStatus) {
    el.textContent = `Statut: ${out.lastStatus} | Note: ${note20}/20`;
    startBtn.disabled = true; // Test completed, so disable button
    infoEl.textContent = 'Le test a d√©j√† √©t√© effectu√©.';
  } else {
    el.textContent = `Questions restantes: ${out.remaining}/${out.total}`;
    startBtn.disabled = false;
    infoEl.textContent = '';
  }
  
  // Note: on ne surcharge plus la section progression avec les formulaires mati√®re pour √©viter des appels simultan√©s
}
    document.getElementById('startBtn').addEventListener('click', async () => {
      const out = await api('/api/questions');
      if (out.error) {
        console.error('API Error:', out.error);
        document.getElementById('info').textContent = out.error;
      } else {
        sessionStorage.setItem('testQuestions', JSON.stringify(out.questions));
        sessionStorage.removeItem('currentFormId');
        window.location.href = '/test.html';
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await api('/api/logout', { method: 'POST' });
      window.location.href = '/';
    });
    fetchUserData(); // Call this to fetch user data and then forms
    // fetchAndDisplayCompletedForms(); // Moved inside fetchUserData
    refreshProgress();

    // Modale r√©ponses
    ensureAnswersModal();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
